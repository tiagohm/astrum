package br.tiagohm.astrum.sky.core.nutation

import br.tiagohm.astrum.common.JD_HOUR
import br.tiagohm.astrum.common.M_ARCSEC_RAD
import br.tiagohm.astrum.common.units.angle.Angle
import br.tiagohm.astrum.common.units.angle.Radians
import br.tiagohm.astrum.sky.core.time.JulianDay
import kotlin.math.abs
import kotlin.math.cos
import kotlin.math.sin

data class Nutation(
    val deltaPsi: Angle = Radians.ZERO,
    val deltaEpsilon: Angle = Radians.ZERO,
) {

    companion object {

        val EMPTY = Nutation()

        private var lastJDENut = 0.0
        private var deltaPsi = 0.0
        private var deltaEpsilon = 0.0

        fun compute(jde: JulianDay): Nutation {
            val JDE = jde.value

            if ((JDE <= NUT_BEGIN - NUT_TRANSITION) || (JDE >= NUT_END + NUT_TRANSITION)) {
                return EMPTY
            }

            if (abs(JDE - lastJDENut) >= JD_HOUR) {
                lastJDENut = JDE

                var DeltaPsi = 0.0
                var DeltaEpsilon = 0.0

                val t = (JDE - 2451545.0) / 36525.0
                // Mean anomaly of Moon
                val l = 485868.249036 + 1717915923.2178 * t
                // Mean anomaly of Sun
                val ls = 1287104.79305 + 129596581.0481 * t
                // Mean longitude of the Moon
                val f = 335779.526232 + 1739527262.8478 * t
                // Mean elongation of the Moon from the Sun
                val d = 1072260.70369 + 1602961601.2090 * t
                // Mean longitude of the ascending node of the lunar orbit
                val omega = 450160.398036 - 6962890.5431 * t

                for (i in 0..77) {
                    val nut = NUT_2000B[i]
                    val theta = (nut.l * l + nut.ls * ls + nut.f * f + nut.d * d + nut.omega * omega) * M_ARCSEC_RAD
                    val sinTheta = sin(theta)
                    val cosTheta = cos(theta)
                    DeltaPsi += (nut.a + nut.ap * t) * sinTheta + nut.app * cosTheta
                    DeltaEpsilon += (nut.b + nut.bp * t) * cosTheta + nut.bpp * sinTheta
                }

                // Convert from units of 0.1uas to arcsec. (The paper says mas, but this is an error!)
                DeltaPsi *= 1E-7
                DeltaEpsilon *= 1E-7
                DeltaPsi -= 0.29965 * t + 0.0417750 + 0.0015835
                DeltaEpsilon -= 0.02524 * t + 0.0068192 - 0.0016339
                deltaPsi = DeltaPsi * M_ARCSEC_RAD
                deltaEpsilon = DeltaEpsilon * M_ARCSEC_RAD
            }

            val limiter = when {
                JDE < NUT_BEGIN -> 1.0 - (NUT_BEGIN - JDE) / NUT_TRANSITION
                JDE > NUT_END -> 1.0 - (JDE - NUT_END) / NUT_TRANSITION
                else -> 1.0
            }

            return Nutation(Radians(deltaPsi * limiter), Radians(deltaEpsilon * limiter))
        }

        private const val NUT_BEGIN = 2268932.5
        private const val NUT_END = 2634166.5
        private const val NUT_TRANSITION = 100.0

        private val NUT_2000B = arrayOf(
            Nut2000B(0.0, 0.0, 0.0, 0.0, 1.0, -6798.35, -172064161.0, -174666.0, 92052331.0, 9086.0, 33386.0, 15377.0),
            Nut2000B(0.0, 0.0, 2.0, -2.0, 2.0, 182.62, -13170906.0, -1675.0, 5730336.0, -3015.0, -13696.0, -4587.0),
            Nut2000B(0.0, 0.0, 2.0, 0.0, 2.0, 13.66, -2276413.0, -234.0, 978459.0, -485.0, 2796.0, 1374.0),
            Nut2000B(0.0, 0.0, 0.0, 0.0, 2.0, -3399.18, 2074554.0, 207.0, -897492.0, 470.0, -698.0, -291.0),
            Nut2000B(0.0, 1.0, 0.0, 0.0, 0.0, 365.26, 1475877.0, -3633.0, 73871.0, -184.0, 11817.0, -1924.0),
            Nut2000B(0.0, 1.0, 2.0, -2.0, 2.0, 121.75, -516821.0, 1226.0, 224386.0, -677.0, -524.0, -174.0),
            Nut2000B(1.0, 0.0, 0.0, 0.0, 0.0, 27.55, 711159.0, 73.0, -6750.0, 0.0, -872.0, 358.0),
            Nut2000B(0.0, 0.0, 2.0, 0.0, 1.0, 13.63, -387298.0, -367.0, 200728.0, 18.0, 380.0, 318.0),
            Nut2000B(1.0, 0.0, 2.0, 0.0, 2.0, 9.13, -301461.0, -36.0, 129025.0, -63.0, 816.0, 367.0),
            Nut2000B(0.0, -1.0, 2.0, -2.0, 2.0, 365.22, 215829.0, -494.0, -95929.0, 299.0, 111.0, 132.0),
            Nut2000B(0.0, 0.0, 2.0, -2.0, 1.0, 177.84, 128227.0, 137.0, -68982.0, -9.0, 181.0, 39.0),
            Nut2000B(-1.0, 0.0, 2.0, 0.0, 2.0, 27.09, 123457.0, 11.0, -53311.0, 32.0, 19.0, -4.0),
            Nut2000B(-1.0, 0.0, 0.0, 2.0, 0.0, 31.81, 156994.0, 10.0, -1235.0, 0.0, -168.0, 82.0),
            Nut2000B(1.0, 0.0, 0.0, 0.0, 1.0, 27.67, 63110.0, 63.0, -33228.0, 0.0, 27.0, -9.0),
            Nut2000B(-1.0, 0.0, 0.0, 0.0, 1.0, -27.44, -57976.0, -63.0, 31429.0, 0.0, -189.0, -75.0),
            Nut2000B(-1.0, 0.0, 2.0, 2.0, 2.0, 9.56, -59641.0, -11.0, 25543.0, -11.0, 149.0, 66.0),
            Nut2000B(1.0, 0.0, 2.0, 0.0, 1.0, 9.12, -51613.0, -42.0, 26366.0, 0.0, 129.0, 78.0),
            Nut2000B(-2.0, 0.0, 2.0, 0.0, 1.0, 1305.48, 45893.0, 50.0, -24236.0, -10.0, 31.0, 20.0),
            Nut2000B(0.0, 0.0, 0.0, 2.0, 0.0, 14.77, 63384.0, 11.0, -1220.0, 0.0, -150.0, 29.0),
            Nut2000B(0.0, 0.0, 2.0, 2.0, 2.0, 7.10, -38571.0, -1.0, 16452.0, -11.0, 158.0, 68.0),
            Nut2000B(-2.0, 0.0, 0.0, 2.0, 0.0, -205.89, -47722.0, 0.0, 477.0, 0.0, -18.0, -25.0),

            Nut2000B(2.0, 0.0, 2.0, 0.0, 2.0, 6.86, -31046.0, -1.0, 13238.0, -11.0, 131.0, 59.0),
            Nut2000B(1.0, 0.0, 2.0, -2.0, 2.0, 23.94, 28593.0, 0.0, -12338.0, 10.0, -1.0, -3.0),
            Nut2000B(-1.0, 0.0, 2.0, 0.0, 1.0, 26.98, 20441.0, 21.0, -10758.0, 0.0, 10.0, -3.0),
            Nut2000B(2.0, 0.0, 0.0, 0.0, 0.0, 13.78, 29243.0, 0.0, -609.0, 0.0, -74.0, 13.0),
            Nut2000B(0.0, 0.0, 2.0, 0.0, 0.0, 13.61, 25887.0, 0.0, -550.0, 0.0, -66.0, 11.0),
            Nut2000B(0.0, 1.0, 0.0, 0.0, 1.0, 386.00, -14053.0, -25.0, 8551.0, -2.0, 79.0, -45.0),
            Nut2000B(-1.0, 0.0, 0.0, 2.0, 1.0, 31.96, 15164.0, 10.0, -8001.0, 0.0, 11.0, -1.0),
            Nut2000B(0.0, 2.0, 2.0, -2.0, 2.0, 91.31, -15794.0, 72.0, 6850.0, -42.0, -16.0, -5.0),
            Nut2000B(0.0, 0.0, -2.0, 2.0, 0.0, -173.31, 21783.0, 0.0, -167.0, 0.0, 13.0, 13.0),
            Nut2000B(1.0, 0.0, 0.0, -2.0, 1.0, -31.66, -12873.0, -10.0, 6953.0, 0.0, -37.0, -14.0),
            Nut2000B(0.0, -1.0, 0.0, 0.0, 1.0, -346.64, -12654.0, 11.0, 6415.0, 0.0, 63.0, 26.0),
            Nut2000B(-1.0, 0.0, 2.0, 2.0, 1.0, 9.54, -10204.0, 0.0, 5222.0, 0.0, 25.0, 15.0),
            Nut2000B(0.0, 2.0, 0.0, 0.0, 0.0, 182.63, 16707.0, -85.0, 168.0, -1.0, -10.0, 10.0),
            Nut2000B(1.0, 0.0, 2.0, 2.0, 2.0, 5.64, -7691.0, 0.0, 3268.0, 0.0, 44.0, 19.0),
            Nut2000B(-2.0, 0.0, 2.0, 0.0, 0.0, 1095.18, -11024.0, 0.0, 104.0, 0.0, -14.0, 2.0),
            Nut2000B(0.0, 1.0, 2.0, 0.0, 2.0, 13.17, 7566.0, -21.0, -3250.0, 0.0, -11.0, -5.0),
            Nut2000B(0.0, 0.0, 2.0, 2.0, 1.0, 7.09, -6637.0, -11.0, 3353.0, 0.0, 25.0, 14.0),
            Nut2000B(0.0, -1.0, 2.0, 0.0, 2.0, 14.19, -7141.0, 21.0, 3070.0, 0.0, 8.0, 4.0),
            Nut2000B(0.0, 0.0, 0.0, 2.0, 1.0, 14.80, -6302.0, -11.0, 3272.0, 0.0, 2.0, 4.0),
            Nut2000B(1.0, 0.0, 2.0, -2.0, 1.0, 23.86, 5800.0, 10.0, -3045.0, 0.0, 2.0, -1.0),
            Nut2000B(2.0, 0.0, 2.0, -2.0, 2.0, 12.81, 6443.0, 0.0, -2768.0, 0.0, -7.0, -4.0),

            Nut2000B(-2.0, 0.0, 0.0, 2.0, 1.0, -199.84, -5774.0, -11.0, 3041.0, 0.0, -15.0, -5.0),
            Nut2000B(2.0, 0.0, 2.0, 0.0, 1.0, 6.85, -5350.0, 0.0, 2695.0, 0.0, 21.0, 12.0),
            Nut2000B(0.0, -1.0, 2.0, -2.0, 1.0, 346.60, -4752.0, -11.0, 2719.0, 0.0, -3.0, -3.0),
            Nut2000B(0.0, 0.0, 0.0, -2.0, 1.0, -14.73, -4940.0, -11.0, 2720.0, 0.0, -21.0, -9.0),
            Nut2000B(-1.0, -1.0, 0.0, 2.0, 0.0, 34.85, 7350.0, 0.0, -51.0, 0.0, -8.0, 4.0),
            Nut2000B(2.0, 0.0, 0.0, -2.0, 1.0, 212.32, 4065.0, 0.0, -2206.0, 0.0, 6.0, 1.0),
            Nut2000B(1.0, 0.0, 0.0, 2.0, 0.0, 9.61, 6579.0, 0.0, -199.0, 0.0, -24.0, 2.0),
            Nut2000B(0.0, 1.0, 2.0, -2.0, 1.0, 119.61, 3579.0, 0.0, -1900.0, 0.0, 5.0, 1.0),
            Nut2000B(1.0, -1.0, 0.0, 0.0, 0.0, 29.80, 4725.0, 0.0, -41.0, 0.0, -6.0, 3.0),
            Nut2000B(-2.0, 0.0, 2.0, 0.0, 2.0, 1615.76, -3075.0, 0.0, 1313.0, 0.0, -2.0, -1.0),
            Nut2000B(3.0, 0.0, 2.0, 0.0, 2.0, 5.49, -2904.0, 0.0, 1233.0, 0.0, 15.0, 7.0),
            Nut2000B(0.0, -1.0, 0.0, 2.0, 0.0, 15.39, 4348.0, 0.0, -81.0, 0.0, -10.0, 2.0),
            Nut2000B(1.0, -1.0, 2.0, 0.0, 2.0, 9.37, -2878.0, 0.0, 1232.0, 0.0, 8.0, 4.0),
            Nut2000B(0.0, 0.0, 0.0, 1.0, 0.0, 29.53, -4230.0, 0.0, -20.0, 0.0, 5.0, -2.0),
            Nut2000B(-1.0, -1.0, 2.0, 2.0, 2.0, 9.81, -2819.0, 0.0, 1207.0, 0.0, 7.0, 3.0),
            Nut2000B(-1.0, 0.0, 2.0, 0.0, 0.0, 26.88, -4056.0, 0.0, 40.0, 0.0, 5.0, -2.0),
            Nut2000B(0.0, -1.0, 2.0, 2.0, 2.0, 7.24, -2647.0, 0.0, 1129.0, 0.0, 11.0, 5.0),
            Nut2000B(-2.0, 0.0, 0.0, 0.0, 1.0, -13.75, -2294.0, 0.0, 1266.0, 0.0, -10.0, -4.0),
            Nut2000B(1.0, 1.0, 2.0, 0.0, 2.0, 8.91, 2481.0, 0.0, -1062.0, 0.0, -7.0, -3.0),
            Nut2000B(2.0, 0.0, 0.0, 0.0, 1.0, 13.81, 2179.0, 0.0, -1129.0, 0.0, -2.0, -2.0),
            Nut2000B(-1.0, 1.0, 0.0, 1.0, 0.0, 3232.87, 3276.0, 0.0, -9.0, 0.0, 1.0, 0.0),

            Nut2000B(1.0, 1.0, 0.0, 0.0, 0.0, 25.62, -3389.0, 0.0, 35.0, 0.0, 5.0, -2.0),
            Nut2000B(1.0, 0.0, 2.0, 0.0, 0.0, 9.11, 3339.0, 0.0, -107.0, 0.0, -13.0, 1.0),
            Nut2000B(-1.0, 0.0, 2.0, -2.0, 1.0, -32.61, -1987.0, 0.0, 1073.0, 0.0, -6.0, -2.0),
            Nut2000B(1.0, 0.0, 0.0, 0.0, 2.0, 27.78, -1981.0, 0.0, 854.0, 0.0, 0.0, 0.0),
            Nut2000B(-1.0, 0.0, 0.0, 1.0, 0.0, -411.78, 4026.0, 0.0, -553.0, 0.0, -353.0, -139.0),
            Nut2000B(0.0, 0.0, 2.0, 1.0, 2.0, 9.34, 1660.0, 0.0, -710.0, 0.0, -5.0, -2.0),
            Nut2000B(-1.0, 0.0, 2.0, 4.0, 2.0, 5.80, -1521.0, 0.0, 647.0, 0.0, 9.0, 4.0),
            Nut2000B(-1.0, 1.0, 0.0, 1.0, 1.0, 6146.17, 1314.0, 0.0, -700.0, 0.0, 0.0, 0.0),
            Nut2000B(0.0, -2.0, 2.0, -2.0, 1.0, 6786.31, -1283.0, 0.0, 672.0, 0.0, 0.0, 0.0),
            Nut2000B(1.0, 0.0, 2.0, 2.0, 1.0, 5.64, -1331.0, 0.0, 663.0, 0.0, 8.0, 4.0),
            Nut2000B(-2.0, 0.0, 2.0, 2.0, 2.0, 14.63, 1383.0, 0.0, -594.0, 0.0, -2.0, -2.0),
            Nut2000B(-1.0, 0.0, 0.0, 0.0, 2.0, -27.33, 1405.0, 0.0, -610.0, 0.0, 4.0, 2.0),
            Nut2000B(1.0, 1.0, 2.0, -2.0, 2.0, 22.47, 1290.0, 0.0, -556.0, 0.0, 0.0, 0.0),
            Nut2000B(-2.0, 0.0, 2.0, 4.0, 2.0, 7.35, -1214.0, 0.0, 518.0, 0.0, 5.0, 2.0),
            Nut2000B(-1.0, 0.0, 4.0, 0.0, 2.0, 9.06, 1146.0, 0.0, -490.0, 0.0, -3.0, -1.0),
        )
    }
}